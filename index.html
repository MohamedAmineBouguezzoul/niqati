<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>مُنظِّم دراسة زوجتي</title>
  <style>
    :root{
      --bg:#fafafc; /* وضع نهاري */
      --card:#ffffff;
      --text:#1a1a1f;
      --muted:#6b7280;
      --brand:#b325eb;  /* أزرق أكاديمي */
      --brand-2:#630bbb; /* سماوي هادئ */
      --ok:#16a34a;
      --warn:#ea580c;
      --danger:#dc2626;
      --border:#e5e7eb;
      --shadow: 0 6px 20px rgba(0,0,0,.06);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:"Tajawal", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background:var(--bg); color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10; background:var(--bg);
      border-bottom:1px solid var(--border);
      backdrop-filter:saturate(150%) blur(6px);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:16px;}
    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .brand .logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--brand),var(--brand-2)); box-shadow:var(--shadow)}
    .brand h1{margin:0; font-size:22px}

    .top-grid{display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin:12px 0 6px}
    .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px}
    .kpi{display:flex; align-items:center; justify-content:space-between}
    .kpi h3{margin:0; font-size:14px; color:var(--muted)}
    .kpi .val{font-size:28px; font-weight:700}
    .kpi .sub{font-size:12px; color:var(--muted)}

    nav.tabs{display:flex; gap:8px; flex-wrap:wrap; margin:10px 0 14px}
    nav.tabs button{
      border:1px solid var(--border); background:var(--card); color:var(--text);
      padding:10px 14px; border-radius:999px; cursor:pointer; box-shadow:var(--shadow);
    }
    nav.tabs button.active{background:linear-gradient(135deg,var(--brand),var(--brand-2)); color:white; border-color:transparent}

    section.view{display:none}
    section.view.active{display:block}

    .grid-2{display:grid; grid-template-columns:1.1fr .9fr; gap:14px}
    .grid-3{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
    .grid{display:grid; gap:10px}

    h2{margin:0 0 8px; font-size:18px}
    h3{margin:8px 0 6px; font-size:16px}
    label{font-size:13px; color:var(--muted)}
    input, select, textarea{width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:#fff; font-family:inherit}
    textarea{min-height:90px}
    .row{display:flex; gap:8px; align-items:center}
    .row.wrap{flex-wrap:wrap}
    .btn{padding:10px 14px; border-radius:999px; border:1px solid var(--border); background:var(--card); cursor:pointer}
    .btn.brand{background:linear-gradient(135deg,var(--brand),var(--brand-2)); color:#fff; border-color:transparent}
    .btn.ghost{background:transparent}
    .btn.warn{background:var(--warn); color:#fff; border-color:transparent}
    .btn.danger{background:var(--danger); color:#fff; border-color:transparent}
    .btn.ok{background:var(--ok); color:#fff; border-color:transparent}
    .tiny{font-size:12px; color:var(--muted)}

    table{width:100%; border-collapse:separate; border-spacing:0 8px}
    th,td{text-align:center; padding:8px 10px}
    thead th{color:var(--muted); font-size:13px}
    tbody tr{background:var(--card); box-shadow:var(--shadow)}
    tbody td{border-top:1px solid var(--border); border-bottom:1px solid var(--border)}
    tbody td:first-child{border-right:1px solid var(--border); border-top-right-radius:12px; border-bottom-right-radius:12px}
    tbody td:last-child{border-left:1px solid var(--border); border-top-left-radius:12px; border-bottom-left-radius:12px}

    .progress{
      height:12px; width:100%; background:#f3f4f6; border-radius:999px; overflow:hidden; border:1px solid var(--border)
    }
    .progress>span{display:block; height:100%; background:linear-gradient(90deg,var(--brand),var(--brand-2)); width:0}

    .list{display:grid; gap:8px}
    .list .item{display:flex; justify-content:space-between; align-items:center; padding:10px 12px; background:var(--card); border:1px solid var(--border); border-radius:12px}

    .pill{font-size:12px; padding:4px 8px; border-radius:999px; background:#eef2ff; color:#3730a3}

    .foot-note{font-size:12px; color:var(--muted)}

    @media (max-width: 900px){
      .grid-2{grid-template-columns:1fr}
      .top-grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>مُنظِّم دراسة زوجتي</h1>
          <div class="tiny">صفحة لمتابعة الدراسة، النقاط، المكافآت، والتقدّم بعيد المدى</div>
        </div>
      </div>
      <div class="top-grid">
        <div class="card kpi">
          <div>
            <h3>النقاط المُتاحة</h3>
            <div class="val" id="kpiPoints">0</div>
            <div class="sub">تُكتسب بالإنجازات ويمكن استبدالها بهدايا</div>
          </div>
          <div class="row wrap">
            <button class="btn brand" onclick="openTab('rewards')">المكافآت</button>
            <button class="btn" onclick="addPointsPrompt()">+ إضافة نقاط</button>
            <button class="btn ghost" onclick="resetConfirm('points')">تصفير</button>
          </div>
        </div>
        <div class="card kpi">
          <div>
            <h3>سلسلة الأيام (الإلتزام)</h3>
            <div class="val" id="kpiStreak">0 يوم</div>
            <div class="sub">تزيد إذا أُنجز هدف اليوم</div>
          </div>
          <div class="row wrap">
            <button class="btn ok" onclick="markTodayComplete()">تم إنجاز هدف اليوم</button>
            <button class="btn ghost" onclick="resetConfirm('streak')">تصفير</button>
          </div>
        </div>
        <div class="card kpi">
          <div>
            <h3>جلسة تركيز</h3>
            <div class="val" id="kpiTimer">25:00</div>
            <div class="sub">مؤقّت بومودورو: 25/5</div>
          </div>
          <div class="row wrap">
            <button class="btn ok" onclick="startPomodoro()">بدء</button>
            <button class="btn warn" onclick="pausePomodoro()">إيقاف مؤقّت</button>
            <button class="btn ghost" onclick="resetPomodoro()">إعادة</button>
          </div>
        </div>
      </div>
      <nav class="tabs">
        <button class="active" data-tab="today" onclick="openTab('today')">الجدول اليومي (٣ مواد)</button>
        <button data-tab="week" onclick="openTab('week')">الخطة الأسبوعية</button>
        <button data-tab="subjects" onclick="openTab('subjects')">المواد والتقدّم البعيد</button>
        <button data-tab="rewards" onclick="openTab('rewards')">المكافآت والهدايا</button>
        <button data-tab="tools" onclick="openTab('tools')">أدوات مساعدة</button>
        <button data-tab="backup" onclick="openTab('backup')">نسخة احتياطية</button>
      </nav>
    </div>
  </header>

  <main class="wrap" id="app">
    <!-- اليوم: ثلاثة مواد -->
    <section id="view-today" class="view active">
      <div class="grid-2">
        <div class="card">
          <h2>جدول اليوم — ثلاث مواد</h2>
          <div class="grid">
            <div class="row wrap">
              <label>تاريخ اليوم</label>
              <input type="date" id="todayDate">
            </div>
            <div class="grid-3">
              <div class="subCard">
                <h3>المادة ١</h3>
                <select id="d1Subject"></select>
                <div class="row"><input id="d1Plan" type="text" placeholder="خُطّة مختصرة (مثال: صفحات 10–20)"/></div>
                <div class="row wrap">
                  <button class="btn ok" onclick="finishSession(1)">إنجاز + نقاط</button>
                  <button class="btn ghost" onclick="logNote(1)">إضافة ملاحظة</button>
                </div>
                <div class="tiny" id="d1Note"></div>
              </div>
              <div class="subCard">
                <h3>المادة ٢</h3>
                <select id="d2Subject"></select>
                <div class="row"><input id="d2Plan" type="text" placeholder="خُطّة مختصرة"/></div>
                <div class="row wrap">
                  <button class="btn ok" onclick="finishSession(2)">إنجاز + نقاط</button>
                  <button class="btn ghost" onclick="logNote(2)">إضافة ملاحظة</button>
                </div>
                <div class="tiny" id="d2Note"></div>
              </div>
              <div class="subCard">
                <h3>المادة ٣</h3>
                <select id="d3Subject"></select>
                <div class="row"><input id="d3Plan" type="text" placeholder="خُطّة مختصرة"/></div>
                <div class="row wrap">
                  <button class="btn ok" onclick="finishSession(3)">إنجاز + نقاط</button>
                  <button class="btn ghost" onclick="logNote(3)">إضافة ملاحظة</button>
                </div>
                <div class="tiny" id="d3Note"></div>
              </div>
            </div>
            <div class="row wrap">
              <button class="btn brand" onclick="saveToday()">حفظ اليوم</button>
              <span class="tiny">يتم الحفظ أيضًا تلقائيًا في المتصفّح</span>
            </div>
          </div>
        </div>
        <div class="card">
          <h2>إنجازات سريعة (للنقاط)</h2>
          <div class="list" id="achievementsList"></div>
          <div class="row wrap" style="margin-top:8px">
            <input id="achName" placeholder="اسم الإنجاز (مثال: جلسة 30 دقيقة)"/>
            <input id="achPoints" type="number" placeholder="نقاط" style="width:140px"/>
            <button class="btn" onclick="addAchievement()">إضافة</button>
            <button class="btn ghost" onclick="resetConfirm('achievements')">تصفير</button>
          </div>
          <div class="foot-note">فائدة: إنجاز اليوم (٣ جلسات) يمنح نقاطًا كافية لشراء هدية صغيرة كل بضعة أيام.</div>
        </div>
      </div>
    </section>

    <!-- أسبوع -->
    <section id="view-week" class="view">
      <div class="card">
        <h2>الخطة الأسبوعية — ثلاث مواد في اليوم</h2>
        <div class="tiny">اختر مادة لكل خانة (الأحد → السبت). يتم الحفظ تلقائيًا.</div>
        <div class="grid" id="weekGrid"></div>
        <div class="row wrap" style="margin-top:10px">
          <button class="btn brand" onclick="saveWeek()">حفظ</button>
          <button class="btn ghost" onclick="clearWeek()">مسح الأسبوع</button>
        </div>
      </div>
    </section>

    <!-- المواد والتقدم -->
    <section id="view-subjects" class="view">
      <div class="grid-2">
        <div class="card">
          <h2>إدارة المواد</h2>
          <div class="row wrap">
            <input id="subjName" placeholder="اسم المادة"/>
            <input id="subjPagesTotal" type="number" placeholder="إجمالي الصفحات"/>
            <input id="subjMemTotal" type="number" placeholder="إجمالي المحفوظ (كمية)"/>
            <button class="btn" onclick="addSubject()">إضافة مادة</button>
          </div>
          <div class="list" id="subjectsList"></div>
        </div>
        <div class="card">
          <h2>التقدّم بعيد المدى</h2>
          <table>
            <thead>
              <tr>
                <th>المادة</th>
                <th>الصفحات</th>
                <th>٪ قراءات</th>
                <th>المحفوظ</th>
                <th>٪ حفظ</th>
                <th>تحديث سريع</th>
              </tr>
            </thead>
            <tbody id="progressTable"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- مكافآت -->
    <section id="view-rewards" class="view">
      <div class="grid-2">
        <div class="card">
          <h2>متجر الهدايا (حسب النقاط)</h2>
          <div class="row wrap">
            <input id="rewardName" placeholder="اسم الهدية"/>
            <input id="rewardCost" type="number" placeholder="التكلفة بالنقاط"/>
            <button class="btn" onclick="addReward()">إضافة</button>
          </div>
          <div class="list" id="rewardsList"></div>
        </div>
        <div class="card">
          <h2>سجل الاستبدالات</h2>
          <div class="list" id="redemptions"></div>
        </div>
      </div>
    </section>

    <!-- أدوات -->
    <section id="view-tools" class="view">
      <div class="grid-2">
        <div class="card">
          <h2>ملاحظات اليوم</h2>
          <textarea id="dailyNotes" placeholder="أفكار، ملخصات، أسئلة لليوم..." oninput="saveNotes()"></textarea>
          <div class="row wrap" style="margin-top:8px">
            <button class="btn brand" onclick="copyNotes()">نسخ الملاحظات</button>
            <span class="tiny">يُحفظ تلقائيًا</span>
          </div>
        </div>
        <div class="card">
          <h2>قائمة أهداف اليوم</h2>
          <div class="row wrap">
            <input id="todoInput" placeholder="أضف هدفًا"/>
            <button class="btn" onclick="addTodo()">إضافة</button>
            <button class="btn ghost" onclick="clearTodos()">مسح</button>
          </div>
          <div class="list" id="todoList"></div>
        </div>
      </div>
      <div class="card" style="margin-top:12px">
        <h2>حساب نسبة الإنجاز اليومي</h2>
        <div class="row wrap">
          <input id="todayDone" type="number" placeholder="منجز" style="width:160px"/>
          <input id="todayTotal" type="number" placeholder="الإجمالي" style="width:160px"/>
          <button class="btn" onclick="calcTodayPct()">احسب</button>
          <span id="todayPct" class="pill">0٪</span>
        </div>
      </div>
    </section>

    <!-- نسخ احتياطي -->
    <section id="view-backup" class="view">
      <div class="grid-2">
        <div class="card">
          <h2>نسخ احتياطي واسترجاع</h2>
          <div class="row wrap">
            <button class="btn brand" onclick="downloadBackup()">تحميل نسخة JSON</button>
            <input type="file" id="backupFile" accept="application/json"/>
            <button class="btn" onclick="restoreBackup()">استرجاع</button>
          </div>
          <div class="foot-note">تُحفظ كل البيانات محليًا في المتصفّح (localStorage). النسخة الاحتياطية مفيدة للمشاركة بين الأجهزة.</div>
        </div>
        <div class="card">
          <h2>طباعة</h2>
          <div class="row wrap">
            <button class="btn" onclick="window.print()">طباعة الصفحة</button>
          </div>
          <div class="tiny">تظهر بطابع بسيط مناسب للطباعة.</div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ——— بيانات ———
    const storeKey = 'studyApp_v1_ar';
    const state = JSON.parse(localStorage.getItem(storeKey) || '{}');

    // حالة افتراضية
    if(!state.points){
      Object.assign(state,{
        points:0,
        streak:{count:0,lastDone:null},
        subjects:[], // {id,name,pagesTotal,pagesRead,memTotal,memDone}
        achievements:[ // نماذج جاهزة قابلة للتعديل
          {id:uid(), name:'جلسة تركيز 25 دقيقة', pts:5},
          {id:uid(), name:'إنهاء هدف اليوم (٣ مواد)', pts:15},
          {id:uid(), name:'مراجعة حفظ 15 دقيقة', pts:4},
        ],
        rewards:[{id:uid(), name:'شوكولاتة', cost:20}],
        redemptions:[],
        weekPlan: genEmptyWeek(),
        today:{date:todaysDate(), sessions:[{}, {}, {}], notes:'', todos:[]}
      });
      persist();
    }

    function genEmptyWeek(){
      const days = ['الأحد','الإثنين','الثلاثاء','الأربعاء','الخميس','الجمعة','السبت'];
      const w={};
      days.forEach(d=> w[d] = [{subjId:null, plan:''},{subjId:null, plan:''},{subjId:null, plan:''}]);
      return w;
    }

    function uid(){ return Math.random().toString(36).slice(2,9); }
    function persist(){ localStorage.setItem(storeKey, JSON.stringify(state)); updateUI(); }
    function todaysDate(){ return new Date().toISOString().slice(0,10); }

    // ——— تبويب ———
    function openTab(id){
      document.querySelectorAll('nav.tabs button').forEach(b=>{
        b.classList.toggle('active', b.dataset.tab===id);
      });
      document.querySelectorAll('section.view').forEach(v=> v.classList.remove('active'));
      document.getElementById(`view-${id}`).classList.add('active');
      if(id==='week') buildWeekGrid();
    }

    // ——— KPI ———
    function addPointsPrompt(){
      const v = +prompt('كم نقطة؟', '1');
      if(!isFinite(v) || v<=0) return;
      state.points += v; persist();
    }

    function resetConfirm(what){
      if(!confirm('هل أنت متأكد؟')) return;
      if(what==='points') state.points=0;
      if(what==='streak') state.streak={count:0,lastDone:null};
      if(what==='achievements') state.achievements=[];
      persist();
    }

    function markTodayComplete(){
      const today = todaysDate();
      if(state.streak.lastDone!==today){
        state.streak.count += 1; state.streak.lastDone=today; persist();
      }
    }

    // ——— بومودورو ———
    let timer=null, remaining=25*60, mode='focus';
    function startPomodoro(){
      if(timer) return; // لا تكرر
      timer = setInterval(()=>{
        remaining--; if(remaining<=0){
          clearInterval(timer); timer=null;
          if(mode==='focus'){ mode='break'; remaining=5*60; alert('أحسنت! خذ استراحة 5 دقائق.'); }
          else { mode='focus'; remaining=25*60; alert('لنعد للتركيز 25 دقيقة.'); }
          updateTimer();
        }
        updateTimer();
      },1000);
    }
    function pausePomodoro(){ clearInterval(timer); timer=null; }
    function resetPomodoro(){ pausePomodoro(); mode='focus'; remaining=25*60; updateTimer(); }
    function updateTimer(){
      const m = String(Math.floor(remaining/60)).padStart(2,'0');
      const s = String(remaining%60).padStart(2,'0');
      document.getElementById('kpiTimer').textContent = m+':'+s;
    }

    // ——— اليوم ———
    function initToday(){
      const d = document.getElementById('todayDate');
      d.value = state.today.date || todaysDate();
      d.onchange = ()=>{ state.today.date=d.value; persist(); };

      const selects=['d1Subject','d2Subject','d3Subject'];
      selects.forEach((id,idx)=> buildSubjectSelect(id, state.today.sessions[idx].subjId||null));
      document.getElementById('d1Plan').value = state.today.sessions[0].plan||'';
      document.getElementById('d2Plan').value = state.today.sessions[1].plan||'';
      document.getElementById('d3Plan').value = state.today.sessions[2].plan||'';
      ['d1Plan','d2Plan','d3Plan'].forEach((id,i)=>{
        document.getElementById(id).oninput = (e)=>{ state.today.sessions[i].plan=e.target.value; persist(); }
      });
      ['d1Note','d2Note','d3Note'].forEach((id,i)=>{
        document.getElementById(id).textContent = state.today.sessions[i].note||'';
      })
    }

    function buildSubjectSelect(elId, selectedId){
      const sel = document.getElementById(elId);
      sel.innerHTML='';
      const opt0 = document.createElement('option'); opt0.value=''; opt0.textContent='— اختر مادة —'; sel.appendChild(opt0);
      state.subjects.forEach(s=>{
        const o = document.createElement('option'); o.value=s.id; o.textContent=s.name; sel.appendChild(o);
      });
      sel.value = selectedId||'';
      sel.onchange = ()=>{ const idx = parseInt(elId[1])-1; state.today.sessions[idx].subjId=sel.value||null; persist(); };
    }

    function finishSession(n){
      const idx=n-1; const s = state.today.sessions[idx];
      if(!s.subjId){ alert('اختر مادة أولاً'); return; }
      const pts = +prompt('كم نقاط تُمنح لهذه الجلسة؟','5');
      if(isFinite(pts) && pts>0){ state.points+=pts; }
      s.done = true; persist();
    }

    function logNote(n){
      const idx=n-1; const t = prompt('ملاحظة مختصرة للجلسة:','');
      if(t!=null){ state.today.sessions[idx].note=t; persist(); initToday(); }
    }

    function saveToday(){ persist(); alert('تم الحفظ'); }

    // ——— أسبوع ———
    function buildWeekGrid(){
      const days=['الأحد','الإثنين','الثلاثاء','الأربعاء','الخميس','الجمعة','السبت'];
      const wrap = document.getElementById('weekGrid');
      wrap.innerHTML='';
      days.forEach(day=>{
        const card = document.createElement('div'); card.className='card';
        card.innerHTML = `<h3>${day}</h3>`;
        const inner = document.createElement('div'); inner.className='grid-3';
        for(let i=0;i<3;i++){
          const box = document.createElement('div');
          const sid = uid();
          box.innerHTML = `
            <label>المادة ${i+1}</label>
            <select id="${sid}"></select>
            <input type="text" placeholder="خُطّة" value="${state.weekPlan[day][i].plan||''}">
          `;
          inner.appendChild(box);
          buildSubjectSelect(sid, state.weekPlan[day][i].subjId||null);
          box.querySelector('select').onchange = (e)=>{ state.weekPlan[day][i].subjId = e.target.value||null; persist(); };
          box.querySelector('input').oninput = (e)=>{ state.weekPlan[day][i].plan = e.target.value; persist(); };
        }
        card.appendChild(inner); wrap.appendChild(card);
      });
    }
    
    function saveWeek(){ persist(); alert('تم الحفظ'); }
    function clearWeek(){ if(confirm('مسح الخطة لهذا الأسبوع؟')){ state.weekPlan=genEmptyWeek(); persist(); buildWeekGrid(); } }

    // ——— المواد والتقدّم ———
    function addSubject(){
      const name = document.getElementById('subjName').value.trim();
      const pt   = +document.getElementById('subjPagesTotal').value;
      const mt   = +document.getElementById('subjMemTotal').value;
      if(!name || pt<0 || mt<0) return alert('تحقّق من المدخلات');
      state.subjects.push({id:uid(), name, pagesTotal:pt||0, pagesRead:0, memTotal:mt||0, memDone:0});
      document.getElementById('subjName').value=''; document.getElementById('subjPagesTotal').value=''; document.getElementById('subjMemTotal').value='';
      persist(); buildSubjects(); buildProgressTable();
    }

    function buildSubjects(){
      const list = document.getElementById('subjectsList'); list.innerHTML='';
      if(state.subjects.length===0){ list.innerHTML='<div class="tiny">لم تُضف أي مادة بعد.</div>'; return; }
      state.subjects.forEach(s=>{
        const it = document.createElement('div'); it.className='item';
        it.innerHTML = `
          <div>
            <div><strong>${s.name}</strong></div>
            <div class="tiny">صفحات: ${s.pagesRead}/${s.pagesTotal} — محفوظ: ${s.memDone}/${s.memTotal}</div>
          </div>
          <div class="row wrap">
            <button class="btn" onclick="incPages('${s.id}',1)">+1 صفحة</button>
            <button class="btn" onclick="incPages('${s.id}',5)">+5</button>
            <button class="btn" onclick="incMem('${s.id}',1)">+1 حفظ</button>
            <button class="btn" onclick="incMem('${s.id}',5)">+5</button>
            <button class="btn ghost" onclick="editSubject('${s.id}')">تحرير</button>
            <button class="btn danger" onclick="deleteSubject('${s.id}')">حذف</button>
          </div>`;
        list.appendChild(it);
      });
      // تحدّث قوائم اختيار المواد
      ['d1Subject','d2Subject','d3Subject'].forEach(id=> buildSubjectSelect(id, document.getElementById(id)?.value));
    }

    function incPages(id,by){ const s=state.subjects.find(x=>x.id===id); s.pagesRead=Math.min(s.pagesTotal, (s.pagesRead||0)+by); persist(); buildSubjects(); buildProgressTable(); }
    function incMem(id,by){ const s=state.subjects.find(x=>x.id===id); s.memDone=Math.min(s.memTotal, (s.memDone||0)+by); persist(); buildSubjects(); buildProgressTable(); }

    function editSubject(id){
      const s = state.subjects.find(x=>x.id===id);
      const name = prompt('اسم المادة', s.name); if(name===null) return;
      const pt = prompt('إجمالي الصفحات', s.pagesTotal); if(pt===null) return;
      const mt = prompt('إجمالي المحفوظ', s.memTotal); if(mt===null) return;
      s.name=name.trim(); s.pagesTotal=+pt||0; s.memTotal=+mt||0; s.pagesRead=Math.min(s.pagesRead, s.pagesTotal); s.memDone=Math.min(s.memDone, s.memTotal);
      persist(); buildSubjects(); buildProgressTable();
    }
    function deleteSubject(id){ if(confirm('حذف المادة؟')){ state.subjects = state.subjects.filter(x=>x.id!==id); persist(); buildSubjects(); buildProgressTable(); } }

    function buildProgressTable(){
      const tb = document.getElementById('progressTable'); tb.innerHTML='';
      state.subjects.forEach(s=>{
        const tr=document.createElement('tr');
        const pctRead = s.pagesTotal? Math.round(100*(s.pagesRead/s.pagesTotal)) : 0;
        const pctMem  = s.memTotal? Math.round(100*(s.memDone/s.memTotal)) : 0;
        tr.innerHTML = `
          <td>${s.name}</td>
          <td>${s.pagesRead}/${s.pagesTotal}</td>
          <td><div class="progress"><span style="width:${pctRead}%"></span></div><div class="tiny">${pctRead}%</div></td>
          <td>${s.memDone}/${s.memTotal}</td>
          <td><div class="progress"><span style="width:${pctMem}%"></span></div><div class="tiny">${pctMem}%</div></td>
          <td>
            <div class="row wrap">
              <input type="number" placeholder="+صفحات" style="width:90px" onkeydown="if(event.key==='Enter'){ incPages('${s.id}', +this.value||0); this.value=''; }">
              <input type="number" placeholder="+حفظ" style="width:90px" onkeydown="if(event.key==='Enter'){ incMem('${s.id}', +this.value||0); this.value=''; }">
            </div>
          </td>`;
        tb.appendChild(tr);
      });
    }

    // ——— إنجازات (نقاط سريعة) ———
    function renderAchievements(){
      const box = document.getElementById('achievementsList'); box.innerHTML='';
      if(state.achievements.length===0){ box.innerHTML='<div class="tiny">أضف إنجازاتك الخاصة هنا.</div>'; return; }
      state.achievements.forEach(a=>{
        const it=document.createElement('div'); it.className='item';
        it.innerHTML = `<div><strong>${a.name}</strong><div class="tiny">+${a.pts} نقطة</div></div>
        <div class="row wrap">
          <button class="btn ok" onclick="award('${a.id}')">منح</button>
          <button class="btn ghost" onclick="editAch('${a.id}')">تحرير</button>
          <button class="btn danger" onclick="delAch('${a.id}')">حذف</button>
        </div>`;
        box.appendChild(it);
      });
    }
    function addAchievement(){
      const n=document.getElementById('achName').value.trim();
      const p=+document.getElementById('achPoints').value;
      if(!n||!isFinite(p)||p<=0) return alert('تحقّق من الاسم والنقاط');
      state.achievements.push({id:uid(), name:n, pts:p});
      document.getElementById('achName').value=''; document.getElementById('achPoints').value='';
      persist(); renderAchievements();
    }
    function award(id){ const a=state.achievements.find(x=>x.id===id); state.points+=a.pts; persist(); }
    function editAch(id){ const a=state.achievements.find(x=>x.id===id); const n=prompt('اسم الإنجاز',a.name); if(n===null) return; const p=prompt('النقاط',a.pts); if(p===null) return; a.name=n.trim(); a.pts=+p||a.pts; persist(); renderAchievements(); }
    function delAch(id){ if(confirm('حذف الإنجاز؟')){ state.achievements=state.achievements.filter(x=>x.id!==id); persist(); renderAchievements(); } }

    // ——— مكافآت ———
    function addReward(){
      const n=document.getElementById('rewardName').value.trim();
      const c=+document.getElementById('rewardCost').value;
      if(!n||!isFinite(c)||c<=0) return alert('تحقّق من الاسم والتكلفة');
      state.rewards.push({id:uid(), name:n, cost:c});
      document.getElementById('rewardName').value=''; document.getElementById('rewardCost').value='';
      persist(); renderRewards();
    }
    function renderRewards(){
      const box=document.getElementById('rewardsList'); box.innerHTML='';
      if(state.rewards.length===0){ box.innerHTML='<div class="tiny">لا توجد هدايا بعد.</div>'; return; }
      state.rewards.forEach(r=>{
        const it=document.createElement('div'); it.className='item';
        it.innerHTML = `<div><strong>${r.name}</strong><div class="tiny">التكلفة: ${r.cost} نقطة</div></div>
          <div class="row wrap">
            <button class="btn brand" onclick="redeem('${r.id}')">استبدال</button>
            <button class="btn ghost" onclick="editReward('${r.id}')">تحرير</button>
            <button class="btn danger" onclick="delReward('${r.id}')">حذف</button>
          </div>`;
        box.appendChild(it);
      });
      renderRedemptions();
    }
    function redeem(id){
      const r=state.rewards.find(x=>x.id===id);
      if(state.points<r.cost) return alert('النقاط غير كافية');
      if(!confirm(`تأكيد استبدال: ${r.name} مقابل ${r.cost} نقطة؟`)) return;
      state.points -= r.cost; state.redemptions.unshift({id:uid(), name:r.name, cost:r.cost, date:new Date().toLocaleDateString('ar')});
      persist();
    }
    function editReward(id){ const r=state.rewards.find(x=>x.id===id); const n=prompt('اسم الهدية',r.name); if(n===null) return; const c=prompt('التكلفة بالنقاط',r.cost); if(c===null) return; r.name=n.trim(); r.cost=+c||r.cost; persist(); renderRewards(); }
    function delReward(id){ if(confirm('حذف الهدية؟')){ state.rewards=state.rewards.filter(x=>x.id!==id); persist(); renderRewards(); } }
    function renderRedemptions(){
      const box=document.getElementById('redemptions'); box.innerHTML='';
      if(state.redemptions.length===0){ box.innerHTML='<div class="tiny">لا يوجد سجل حتى الآن.</div>'; return; }
      state.redemptions.forEach(e=>{
        const it=document.createElement('div'); it.className='item';
        it.innerHTML = `<div><strong>${e.name}</strong><div class="tiny">${e.date}</div></div><div class="pill">-${e.cost}</div>`;
        box.appendChild(it);
      });
    }

    // ——— أدوات ———
    function saveNotes(){ state.today.notes=document.getElementById('dailyNotes').value; persist(); }
    function copyNotes(){ const t=document.getElementById('dailyNotes'); t.select(); document.execCommand('copy'); alert('تم النسخ'); }

    function addTodo(){
      const input=document.getElementById('todoInput'); const txt=input.value.trim(); if(!txt) return;
      state.today.todos.push({id:uid(), text:txt, done:false}); input.value=''; persist(); renderTodos();
    }
    function toggleTodo(id){ const t=state.today.todos.find(x=>x.id===id); t.done=!t.done; persist(); renderTodos(); }
    function clearTodos(){ if(confirm('مسح جميع الأهداف؟')){ state.today.todos=[]; persist(); renderTodos(); } }
    function renderTodos(){
      const box=document.getElementById('todoList'); box.innerHTML='';
      if(state.today.todos.length===0){ box.innerHTML='<div class="tiny">أضف أهدافك اليومية هنا.</div>'; return; }
      state.today.todos.forEach(t=>{
        const it=document.createElement('div'); it.className='item';
        it.innerHTML=`<span ${t.done? 'style="text-decoration:line-through; opacity:.7"':''}>${t.text}</span>
        <div class="row wrap">
          <button class="btn ok" onclick="toggleTodo('${t.id}')">${t.done?'إلغاء':'إنجاز'}</button>
        </div>`;
        box.appendChild(it);
      });
    }

    function calcTodayPct(){
      const a=+document.getElementById('todayDone').value, b=+document.getElementById('todayTotal').value;
      if(!isFinite(a)||!isFinite(b)||b<=0){ return alert('أدخل قيمًا صحيحة'); }
      const pct=Math.round(100*a/b); document.getElementById('todayPct').textContent=pct+'٪';
    }

    // ——— نسخ احتياطي ———
    function downloadBackup(){
      const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='backup-study-app.json'; a.click(); URL.revokeObjectURL(url);
    }
    function restoreBackup(){
      const f=document.getElementById('backupFile').files[0]; if(!f) return alert('اختر ملف النسخة');
      const reader=new FileReader(); reader.onload=()=>{ try{ const data=JSON.parse(reader.result); Object.assign(state, data); persist(); initAll(); alert('تم الاسترجاع.'); }catch(e){ alert('ملف غير صالح'); } }; reader.readAsText(f);
    }

    // ——— التهيئة العامة ———
    function updateUI(){
      document.getElementById('kpiPoints').textContent = state.points;
      document.getElementById('kpiStreak').textContent = state.streak.count + ' يوم';
      renderAchievements(); renderRewards(); renderRedemptions(); buildSubjects(); buildProgressTable(); renderTodos();
      document.getElementById('dailyNotes').value = state.today.notes||'';
    }

    function initAll(){ initToday(); buildWeekGrid(); updateTimer(); updateUI(); }
    window.addEventListener('load', initAll);
  </script>
</body>
</html>
